/**
 * Regression Test: Command Injection Vulnerability
 *
 * Date: 2026-01-07
 * Location: `src/proxy-mcp/supervisor/github.ts` (5箇所)
 * Root Cause: シェルコマンド構築時のセキュリティ考慮不足
 *
 * This test ensures the mistake does not recur.
 */

import * as fs from 'fs';
import * as path from 'path';

const SOURCE_PATH = path.join(__dirname, '../../src/proxy-mcp/supervisor/github.ts');
const source = fs.readFileSync(SOURCE_PATH, 'utf-8');

describe('Regression: Command Injection Vulnerability', () => {
  /**
   * Symptom: execSync で文字列補間を使用、コマンドインジェクション脆弱性
   * Fix: execSync → spawnSync + 配列引数に変更
   */
  it('should not exhibit the original symptom', () => {
    // execSync にテンプレートリテラルで変数を展開して渡すパターンが存在しないことを検証
    const execSyncInterpolation = /execSync\s*\(\s*`[^`]*\$\{/;
    expect(source).not.toMatch(execSyncInterpolation);

    // spawnSync('gh', [...]) パターンが使われていることを検証
    const spawnSyncGh = /spawnSync\s*\(\s*'gh'\s*,\s*\[/;
    expect(source).toMatch(spawnSyncGh);
  });

  it('should follow the prevention guidelines', () => {
    // execSync の使用は固定文字列（gh --version, git remote）のみ許可
    // execSync の全出現箇所を抽出し、各呼び出しが固定文字列であることを検証
    const execSyncCalls = source.match(/execSync\s*\([^)]+\)/g);

    if (execSyncCalls) {
      for (const call of execSyncCalls) {
        // テンプレートリテラル（バッククォート）での変数展開がないことを検証
        expect(call).not.toMatch(/`[^`]*\$\{/);
        // 許可される固定文字列パターンであることを検証
        expect(call).toMatch(/execSync\s*\(\s*'[^']*'/);
      }
    }

    // spawnSync が配列引数パターンで使われていることを検証（複数箇所）
    const spawnSyncArrayCalls = source.match(/spawnSync\s*\(\s*'gh'\s*,\s*\[/g);
    expect(spawnSyncArrayCalls).not.toBeNull();
    expect(spawnSyncArrayCalls!.length).toBeGreaterThanOrEqual(4);
  });
});
